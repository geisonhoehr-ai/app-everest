# DOCUMENTA√á√ÉO COMPLETA DO SISTEMA DE FLASHCARDS

## VIS√ÉO GERAL DO SISTEMA

O sistema de flashcards do Everest √© uma plataforma avan√ßada de aprendizado baseada no algoritmo SM-2 (SuperMemo), que permite aos estudantes revisar conte√∫do de forma eficiente atrav√©s de espa√ßamento inteligente. O sistema inclui funcionalidades de gamifica√ß√£o, progresso personalizado, e m√∫ltiplos modos de estudo.

## ARQUITETURA DO SISTEMA

### üóÑÔ∏è **Estrutura do Banco de Dados**

```sql
-- Tabela principal de mat√©rias
subjects (
  id: uuid PRIMARY KEY,
  name: text NOT NULL,
  description: text,
  image_url: text,
  category: text,
  created_at: timestamp,
  updated_at: timestamp
)

-- T√≥picos dentro de cada mat√©ria
topics (
  id: uuid PRIMARY KEY,
  subject_id: uuid REFERENCES subjects(id),
  name: text NOT NULL,
  description: text,
  created_at: timestamp,
  updated_at: timestamp
)

-- Flashcards individuais
flashcards (
  id: uuid PRIMARY KEY,
  topic_id: uuid REFERENCES topics(id),
  question: text NOT NULL,
  answer: text NOT NULL,
  explanation: text,
  difficulty: integer DEFAULT 1,
  external_resource_url: text,
  created_at: timestamp,
  updated_at: timestamp
)

-- Progresso do usu√°rio (algoritmo SM-2)
flashcard_progress (
  id: uuid PRIMARY KEY,
  user_id: uuid REFERENCES users(id),
  flashcard_id: uuid REFERENCES flashcards(id),
  last_reviewed_at: timestamp,
  next_review_at: timestamp,
  interval_days: integer DEFAULT 1,
  ease_factor: decimal DEFAULT 2.5,
  repetitions: integer DEFAULT 0,
  quality: integer,
  response_time_seconds: integer,
  created_at: timestamp,
  updated_at: timestamp,
  UNIQUE(user_id, flashcard_id)
)

-- Hist√≥rico de sess√µes
flashcard_session_history (
  id: uuid PRIMARY KEY,
  user_id: uuid REFERENCES users(id),
  topic_id: uuid REFERENCES topics(id),
  session_mode: text,
  cards_reviewed: integer,
  correct_answers: integer,
  incorrect_answers: integer,
  started_at: timestamp,
  ended_at: timestamp
)

-- Conjuntos de flashcards personalizados
flashcard_sets (
  id: uuid PRIMARY KEY,
  user_id: uuid REFERENCES users(id),
  name: text NOT NULL,
  description: text,
  is_public: boolean DEFAULT false,
  created_at: timestamp,
  updated_at: timestamp
)

-- Cards em conjuntos personalizados
flashcard_set_cards (
  id: uuid PRIMARY KEY,
  set_id: uuid REFERENCES flashcard_sets(id),
  question: text NOT NULL,
  answer: text NOT NULL,
  explanation: text,
  external_resource_url: text,
  created_at: timestamp,
  updated_at: timestamp
)

-- Colaboradores em conjuntos
flashcard_set_collaborators (
  id: uuid PRIMARY KEY,
  set_id: uuid REFERENCES flashcard_sets(id),
  user_id: uuid REFERENCES users(id),
  permission: text DEFAULT 'viewer', -- 'owner', 'editor', 'viewer'
  created_at: timestamp,
  updated_at: timestamp,
  UNIQUE(set_id, user_id)
)
```

## üì± **P√ÅGINAS E FLUXO COMPLETO**

### 1. **P√°gina Principal de Flashcards** (`/flashcards`)

#### **Estrutura da P√°gina:**
```tsx
// src/pages/Flashcards.tsx
export default function FlashcardsPage() {
  // Estados principais
  const [subjects, setSubjects] = useState<SubjectWithTopicCount[]>([])
  const [isLoading, setIsLoading] = useState(true)

  // Carregamento de dados
  useEffect(() => {
    getSubjects()
      .then(setSubjects)
      .catch(console.error)
      .finally(() => setIsLoading(false))
  }, [])

  // Agrupamento por categoria (Portugu√™s/Regulamentos)
  const groupedSubjects = groupBy(
    subjects,
    (subject) => subject.name === 'Portugu√™s' ? 'Portugu√™s' : 'Regulamentos',
  )
}
```

#### **Funcionalidades:**
- **Hero Section**: T√≠tulo animado com descri√ß√£o do sistema
- **Grid de Mat√©rias**: Cards visuais para cada mat√©ria (Portugu√™s e Regulamentos)
- **Estat√≠sticas em Tempo Real**: N√∫mero de t√≥picos e flashcards por mat√©ria
- **Progresso Visual**: Barras de progresso e badges de status
- **Anima√ß√µes Staggered**: Entrada sequencial dos cards com delays
- **Design Premium**: Efeitos glow, gradientes e LEDs coloridos

#### **Elementos Visuais:**
- **MagicCard** com variante "premium"
- **LEDs coloridos** (purple, cyan, pink, blue, green, orange)
- **Imagens de fundo** din√¢micas para cada mat√©ria
- **Part√≠culas flutuantes** animadas
- **Badges de status** (Ativo, Progresso)
- **Bot√µes com gradientes** e efeitos hover

#### **Navega√ß√£o:**
- Clique em qualquer card ‚Üí `/flashcards/{subjectId}` (p√°gina de t√≥picos)

---

### 2. **P√°gina de T√≥picos** (`/flashcards/{subjectId}`)

#### **Estrutura da P√°gina:**
```tsx
// src/pages/FlashcardTopics.tsx
export default function FlashcardTopicsPage() {
  const { subjectId } = useParams<{ subjectId: string }>()
  const [subject, setSubject] = useState<Subject | null>(null)
  const [topics, setTopics] = useState<TopicWithCardCount[]>([])
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [selectedTopicId, setSelectedTopicId] = useState<string | null>(null)

  // Carregamento de dados
  useEffect(() => {
    const fetchData = async () => {
      const [subjectData, topicsData] = await Promise.all([
        getSubjectById(subjectId),
        getTopicsBySubjectId(subjectId),
      ])
      setSubject(subjectData)
      setTopics(topicsData)
    }
    fetchData()
  }, [subjectId])
}
```

#### **Funcionalidades:**
- **Header com Breadcrumb**: Nome da mat√©ria e bot√£o voltar
- **Grid de T√≥picos**: Cards para cada t√≥pico da mat√©ria
- **Contadores Animados**: N√∫mero de flashcards por t√≥pico
- **Modal de Modo de Estudo**: Di√°logo para selecionar modo de estudo
- **Badges de Status**: Indicadores visuais de atividade

#### **Componente TopicCard:**
```tsx
const TopicCard = ({ topic, index, delay, onStudyClick }: TopicCardProps) => {
  const { count, startAnimation } = useCountAnimation(
    topic.flashcards[0]?.count || 0,
    1000
  )

  return (
    <MagicCard
      led
      ledColor={index % 4 === 0 ? 'cyan' : index % 4 === 1 ? 'purple' : index % 4 === 2 ? 'orange' : 'green'}
      style={{ animationDelay: `${delay}ms` }}
    >
      {/* Conte√∫do do card */}
      <Button onClick={() => onStudyClick(topic.id)}>
        <Play className="h-4 w-4 mr-2" />
        Estudar Agora
      </Button>
    </MagicCard>
  )
}
```

#### **Navega√ß√£o:**
- Clique em "Estudar Agora" ‚Üí Abre modal de modo de estudo
- Modal ‚Üí `/flashcards/{subjectId}/{topicId}/study` com par√¢metros

---

### 3. **Modal de Modo de Estudo** (`StudyModeDialog`)

#### **Estrutura do Modal:**
```tsx
// src/components/flashcards/StudyModeDialog.tsx
const studyModes = [
  {
    name: 'Sess√£o Completa',
    description: 'Estude todos os cards do t√≥pico no seu ritmo.',
    icon: BookOpen,
    mode: 'full',
  },
  {
    name: 'Revis√£o de Dif√≠ceis',
    description: 'Foque nos cards que voc√™ marcou como dif√≠ceis.',
    icon: BrainCircuit,
    mode: 'difficult_review',
  },
  {
    name: 'Modo Rel√¢mpago',
    description: 'Uma revis√£o r√°pida com cards aleat√≥rios.',
    icon: Zap,
    mode: 'lightning',
  },
  {
    name: 'Modo Teste',
    description: 'Simule um ambiente de prova com tempo cronometrado.',
    icon: TestTube,
    mode: 'test',
  },
  {
    name: 'Estudo Livre',
    description: 'Personalize a quantidade e a ordem dos cards.',
    icon: SlidersHorizontal,
    mode: 'free',
  },
]
```

#### **Fluxo do Modal:**
1. **Passo 1**: Sele√ß√£o do modo de estudo
2. **Passo 2**: Sele√ß√£o da quantidade de cards (5, 10, 15, 20, 25, 30, todos)
3. **Navega√ß√£o**: Redireciona para p√°gina de estudo com par√¢metros

#### **Par√¢metros de URL:**
- `?mode=full&count=20` - Sess√£o completa com 20 cards
- `?mode=difficult_review` - Revis√£o de dif√≠ceis
- `?mode=lightning&count=10` - Modo rel√¢mpago com 10 cards

---

### 4. **P√°gina de Estudo** (`/flashcards/{subjectId}/{topicId}/study`)

#### **Estrutura da P√°gina:**
```tsx
// src/pages/FlashcardStudyPage.tsx
export default function FlashcardStudyPage() {
  const { subjectId, topicId } = useParams()
  const [searchParams] = useSearchParams()
  const studyMode = searchParams.get('mode') || 'full'
  const cardCountParam = searchParams.get('count')

  // Estados principais
  const [topicData, setTopicData] = useState<TopicWithSubjectAndCards | null>(null)
  const [studyDeck, setStudyDeck] = useState<Flashcard[]>([])
  const [currentIndex, setCurrentIndex] = useState(0)
  const [isFlipped, setIsFlipped] = useState(false)
  const [sessionResults, setSessionResults] = useState<SessionResult[]>([])

  // Carregamento do deck de estudo
  useEffect(() => {
    const fetchAndSetDeck = async () => {
      let fetchedCards: Flashcard[] = []
      
      if (studyMode === 'difficult_review') {
        fetchedCards = await getDifficultFlashcardsForTopic(topicId)
      } else {
        const data = await getTopicWithCards(topicId)
        if (data) {
          setTopicData(data)
          fetchedCards = data.flashcards
        }
      }

      // Embaralhar cards
      let deck = [...fetchedCards].sort(() => 0.5 - Math.random())
      
      // Limitar quantidade se especificado
      if (cardCountParam && cardCountParam !== 'all') {
        const count = parseInt(cardCountParam, 10)
        if (count > 0 && count < deck.length) {
          deck = deck.slice(0, count)
        }
      }
      
      setStudyDeck(deck)
    }
    fetchAndSetDeck()
  }, [topicId, studyMode, cardCountParam])
}
```

#### **Funcionalidades Principais:**

##### **Interface de Estudo:**
- **Card 3D**: Efeito de flip com CSS transforms
- **Controles de Navega√ß√£o**: Bot√µes anterior/pr√≥ximo
- **Barra de Progresso**: Mostra progresso da sess√£o
- **Contador**: "X / Total" cards
- **Modo Tela Cheia**: Bot√£o para fullscreen

##### **Intera√ß√µes:**
- **Flip do Card**: Clique no card ou barra de espa√ßo
- **Avalia√ß√£o de Qualidade**: Bot√µes "Dif√≠cil", "M√©dio", "F√°cil"
- **Navega√ß√£o por Teclado**: Setas direita/esquerda, espa√ßo
- **Favoritos**: Bot√£o estrela para marcar cards

##### **Algoritmo SM-2:**
```tsx
const handleAnswer = async (quality: number) => {
  if (!isFlipped) {
    toast({
      title: 'Vire o card primeiro!',
      description: 'Veja a resposta antes de avaliar seu conhecimento.',
      variant: 'destructive',
    })
    return
  }

  try {
    await updateFlashcardProgress(currentCard.id, quality)
    const result: 'correct' | 'incorrect' = quality <= 2 ? 'incorrect' : 'correct'
    setSessionResults((prev) => [...prev, { cardId: currentCard.id, result }])
  } catch (error) {
    toast({ title: 'Erro ao salvar progresso', variant: 'destructive' })
  }
  
  setTimeout(handleNext, 200)
}
```

##### **Finaliza√ß√£o da Sess√£o:**
```tsx
const finishSession = async () => {
  if (!topicData) return

  const correct = sessionResults.filter((r) => r.result === 'correct').length
  const incorrect = sessionResults.length - correct

  const sessionPayload: SaveSessionPayload = {
    topicId: topicData.id,
    mode: studyMode,
    totalCards: studyDeck.length,
    correct,
    incorrect,
  }

  const sessionId = await saveFlashcardSession(sessionPayload)
  navigate(`/flashcards/session/${sessionId}/result`)
}
```

---

### 5. **P√°gina de Resultados** (`/flashcards/session/{sessionId}/result`)

#### **Estrutura da P√°gina:**
```tsx
// src/pages/FlashcardSessionResult.tsx
export default function FlashcardSessionResultPage() {
  const { sessionId } = useParams<{ sessionId: string }>()
  const [session, setSession] = useState<FlashcardSession | null>(null)
  const [isShareOpen, setIsShareOpen] = useState(false)

  useEffect(() => {
    if (sessionId) {
      getFlashcardSessionDetails(sessionId)
        .then(setSession)
        .finally(() => setIsLoading(false))
    }
  }, [sessionId])

  const percentage = session.totalCards > 0 
    ? Math.round((session.correct / session.totalCards) * 100) 
    : 0
}
```

#### **Funcionalidades:**
- **Card de Resultados**: Percentual de acertos e estat√≠sticas
- **Revis√£o Detalhada**: Accordion com todos os cards da sess√£o
- **Compartilhamento**: Modal para compartilhar resultados
- **Navega√ß√£o**: Links para hist√≥rico e pr√≥xima sess√£o

#### **Elementos Visuais:**
- **Percentual Grande**: Display centralizado do desempenho
- **√çcones de Status**: CheckCircle (acertos) e XCircle (erros)
- **Accordion**: Revis√£o card por card com pergunta/resposta
- **Bot√µes de A√ß√£o**: Compartilhar e ver hist√≥rico

---

### 6. **P√°gina de Hist√≥rico** (`/flashcards/history`)

#### **Estrutura da P√°gina:**
```tsx
// src/pages/FlashcardSessionHistory.tsx
export default function FlashcardSessionHistoryPage() {
  const [history, setHistory] = useState<FlashcardSession[]>([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    getFlashcardSessionHistory()
      .then(setHistory)
      .finally(() => setIsLoading(false))
  }, [])
}
```

#### **Funcionalidades:**
- **Tabela de Hist√≥rico**: Todas as sess√µes anteriores
- **Informa√ß√µes Detalhadas**: T√≥pico, data, modo, desempenho
- **Links para Detalhes**: Bot√£o para ver resultados completos
- **Formata√ß√£o de Data**: Data e hora em portugu√™s

---

### 7. **Sistema de Conjuntos Personalizados**

#### **P√°gina Meus Conjuntos** (`/flashcards/sets`)
```tsx
// src/pages/MyFlashcardSets.tsx
const mockSets = [
  {
    id: 'set1',
    name: 'Revolu√ß√£o Industrial - Collab',
    description: 'Set de flashcards para a prova de Hist√≥ria.',
    owner: { name: 'Jo√£o Pedro', id: 'user-self' },
    permission: 'owner',
    collaboratorsCount: 3,
    cardCount: 42,
  },
  // ... outros sets
]
```

#### **Funcionalidades:**
- **Grid de Conjuntos**: Cards para cada conjunto
- **Permiss√µes**: Owner, Editor, Viewer
- **Colabora√ß√£o**: Contador de colaboradores
- **A√ß√µes por Permiss√£o**: Estudar, Editar, Gerenciar

#### **P√°gina Editor** (`/flashcards/sets/{setId}/edit`)
```tsx
// src/pages/FlashcardSetEditor.tsx
const flashcardSetSchema = z.object({
  name: z.string().min(3, 'O nome do conjunto √© muito curto.'),
  description: z.string().optional(),
  flashcards: z.array(
    z.object({
      question: z.string().min(1, 'A pergunta √© obrigat√≥ria.'),
      answer: z.string().min(1, 'A resposta √© obrigat√≥ria.'),
      external_resource_url: z.string().url('URL inv√°lida.').optional(),
    }),
  ),
})
```

#### **Funcionalidades do Editor:**
- **Formul√°rio Din√¢mico**: Adicionar/remover flashcards
- **Valida√ß√£o**: Zod para valida√ß√£o de campos
- **Permiss√µes**: Diferentes n√≠veis de acesso
- **Campos**: Pergunta, resposta, URL externa

---

## üîß **SERVI√áOS E API**

### **flashcardService.ts**

#### **Principais Fun√ß√µes:**

```typescript
// Buscar mat√©rias com contagem de t√≥picos
export const getSubjects = async (): Promise<SubjectWithTopicCount[]>

// Buscar t√≥picos de uma mat√©ria
export const getTopicsBySubjectId = async (subjectId: string): Promise<TopicWithCardCount[]>

// Buscar t√≥pico com flashcards
export const getTopicWithCards = async (topicId: string): Promise<TopicWithSubjectAndCards | null>

// Salvar sess√£o de estudo
export const saveFlashcardSession = async (payload: SaveSessionPayload): Promise<string | null>

// Atualizar progresso (algoritmo SM-2)
export const updateFlashcardProgress = async (flashcardId: string, quality: number): Promise<FlashcardProgress>

// Buscar flashcards dif√≠ceis
export const getDifficultFlashcardsForTopic = async (topicId: string): Promise<Flashcard[]>

// Hist√≥rico de sess√µes
export const getFlashcardSessionHistory = async (): Promise<FlashcardSession[]>
```

#### **Algoritmo SM-2:**
```typescript
export const updateFlashcardProgress = async (flashcardId: string, quality: number) => {
  // Calcular novos valores usando algoritmo SM-2
  let newInterval = 1
  let newRepetitions = 1
  let newEaseFactor = 2.5

  if (currentProgress) {
    newEaseFactor = currentProgress.ease_factor
    newRepetitions = currentProgress.repetitions

    if (quality >= 3) {
      if (newRepetitions === 0) {
        newInterval = 1
      } else if (newRepetitions === 1) {
        newInterval = 6
      } else {
        newInterval = Math.round(currentProgress.interval_days * newEaseFactor)
      }
      newRepetitions += 1
    } else {
      newRepetitions = 0
      newInterval = 1
    }

    // Ajustar ease factor
    newEaseFactor = newEaseFactor + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
    newEaseFactor = Math.max(1.3, newEaseFactor)
  }

  const nextReview = new Date(now.getTime() + newInterval * 24 * 60 * 60 * 1000)
  
  // Salvar no banco
  await supabase.from('flashcard_progress').upsert({
    user_id: userId,
    flashcard_id: flashcardId,
    last_reviewed_at: now.toISOString(),
    next_review_at: nextReview.toISOString(),
    interval_days: newInterval,
    ease_factor: newEaseFactor,
    repetitions: newRepetitions,
    quality: quality,
  })
}
```

---

## üé® **DESIGN SYSTEM E COMPONENTES**

### **MagicCard Variants:**
- **Premium**: Cards da p√°gina principal com efeitos avan√ßados
- **Standard**: Cards simples para t√≥picos
- **Study**: Cards de estudo com anima√ß√µes 3D

### **Anima√ß√µes:**
- **Staggered Animation**: Entrada sequencial com delays
- **Count Animation**: Contadores animados
- **Flip Animation**: Efeito 3D nos cards de estudo
- **Particle Animation**: Part√≠culas flutuantes
- **Gradient Shift**: Gradientes animados

### **Cores e LEDs:**
- **Primary**: Azul principal
- **Secondary**: Roxo/cyan para gradientes
- **LED Colors**: purple, cyan, pink, blue, green, orange
- **Status Colors**: Verde (acerto), Vermelho (erro), Amarelo (m√©dio)

---

## üìä **FLUXO COMPLETO DO USU√ÅRIO**

### **1. Entrada no Sistema:**
```
/flashcards ‚Üí Lista de mat√©rias (Portugu√™s/Regulamentos)
```

### **2. Sele√ß√£o de Mat√©ria:**
```
/flashcards/portugues ‚Üí Lista de t√≥picos de Portugu√™s
```

### **3. Sele√ß√£o de T√≥pico:**
```
Modal ‚Üí Escolha modo de estudo ‚Üí Escolha quantidade
/flashcards/portugues/gramatica/study?mode=full&count=20
```

### **4. Sess√£o de Estudo:**
```
Card 1 ‚Üí Flip ‚Üí Avaliar (1-5) ‚Üí Pr√≥ximo
Card 2 ‚Üí Flip ‚Üí Avaliar (1-5) ‚Üí Pr√≥ximo
...
√öltimo Card ‚Üí Finalizar Sess√£o
```

### **5. Resultados:**
```
/flashcards/session/123/result ‚Üí Ver desempenho
‚Üí Compartilhar ou Ver Hist√≥rico
```

### **6. Hist√≥rico:**
```
/flashcards/history ‚Üí Todas as sess√µes anteriores
‚Üí Clique em detalhes ‚Üí Ver resultados espec√≠ficos
```

---

## üöÄ **FUNCIONALIDADES AVAN√áADAS**

### **Modos de Estudo:**
1. **Sess√£o Completa**: Todos os cards do t√≥pico
2. **Revis√£o de Dif√≠ceis**: Apenas cards com ease_factor < 2.0
3. **Modo Rel√¢mpago**: Revis√£o r√°pida aleat√≥ria
4. **Modo Teste**: Ambiente cronometrado
5. **Estudo Livre**: Quantidade personalizada

### **Gamifica√ß√£o:**
- **Progresso Visual**: Barras e percentuais
- **Streaks**: Sequ√™ncias de acertos
- **Conquistas**: Badges por marcos
- **Estat√≠sticas**: Tempo de resposta, precis√£o

### **Colabora√ß√£o:**
- **Conjuntos Compartilhados**: Flashcards em equipe
- **Permiss√µes**: Owner, Editor, Viewer
- **Colabora√ß√£o**: M√∫ltiplos editores
- **P√∫blico**: Conjuntos abertos

### **Personaliza√ß√£o:**
- **Configura√ß√µes**: Tempo, anima√ß√µes, sons
- **Layouts**: Diferentes visualiza√ß√µes
- **Temas**: Claro/escuro
- **Acessibilidade**: Teclado, screen reader

---

## üîí **SEGURAN√áA E PERFORMANCE**

### **Row Level Security (RLS):**
```sql
-- Pol√≠tica para flashcard_progress
CREATE POLICY "Users can only see their own progress" ON flashcard_progress
FOR ALL USING (auth.uid() = user_id);

-- Pol√≠tica para conjuntos
CREATE POLICY "Users can see public sets or their own" ON flashcard_sets
FOR SELECT USING (is_public = true OR user_id = auth.uid());
```

### **Otimiza√ß√µes:**
- **Lazy Loading**: Carregamento sob demanda
- **Caching**: Cache de sess√µes e progresso
- **Batch Operations**: M√∫ltiplas atualiza√ß√µes em lote
- **Indexes**: √çndices para consultas frequentes

### **Valida√ß√£o:**
- **Frontend**: Zod schemas para valida√ß√£o
- **Backend**: Valida√ß√£o no Supabase
- **Sanitiza√ß√£o**: Limpeza de inputs
- **Rate Limiting**: Limite de requisi√ß√µes

---

Este sistema de flashcards representa uma implementa√ß√£o completa e moderna de uma plataforma de aprendizado espa√ßado, com funcionalidades avan√ßadas de gamifica√ß√£o, colabora√ß√£o e personaliza√ß√£o, tudo integrado ao ecossistema educacional do Everest.
