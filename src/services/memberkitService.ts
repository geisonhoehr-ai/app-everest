import { supabase } from '@/lib/supabase/client'

const MEMBERKIT_API_KEY = '3cG57cb4CAgAKMX7Fg59qY8f'
const MEMBERKIT_BASE_URL = 'https://memberkit.com.br/api/v1'

interface MemberkitCourse {
  id: number
  name: string
  description?: string
  created_at: string
  updated_at: string
  [key: string]: any
}

interface MemberkitStudent {
  id: number
  name: string
  email: string
  [key: string]: any
}

/**
 * Busca todos os cursos/turmas da Memberkit
 */
export async function fetchMemberkitCourses(): Promise<MemberkitCourse[]> {
  console.log('üìö Buscando cursos da Memberkit...')

  const allCourses: MemberkitCourse[] = []
  let currentPage = 1
  let totalPages = 1

  try {
    while (currentPage <= totalPages) {
      const url = `${MEMBERKIT_BASE_URL}/courses?api_key=${MEMBERKIT_API_KEY}&page=${currentPage}`

      const response = await fetch(url)

      if (!response.ok) {
        throw new Error(`Erro na API Memberkit: ${response.status} ${response.statusText}`)
      }

      // Pegar informa√ß√µes de pagina√ß√£o dos headers
      const totalPagesHeader = response.headers.get('Total-Pages')
      if (totalPagesHeader) {
        totalPages = parseInt(totalPagesHeader, 10)
      }

      const courses = await response.json()
      allCourses.push(...courses)

      console.log(`‚úÖ P√°gina ${currentPage}/${totalPages} - ${courses.length} cursos`)
      currentPage++

      // Respeitar limite de 120 requisi√ß√µes por minuto
      if (currentPage <= totalPages) {
        await new Promise(resolve => setTimeout(resolve, 600)) // 600ms entre requisi√ß√µes
      }
    }

    console.log(`‚úÖ Total de cursos encontrados: ${allCourses.length}`)
    return allCourses
  } catch (error) {
    console.error('‚ùå Erro ao buscar cursos da Memberkit:', error)
    throw error
  }
}

/**
 * Importa um curso da Memberkit para o sistema
 */
export async function importCourseToClass(course: MemberkitCourse) {
  console.log(`üì• Importando curso: ${course.name}`)

  try {
    // Verificar se j√° existe uma turma com esse ID externo
    const { data: existingClass } = await supabase
      .from('classes')
      .select('id')
      .eq('external_id', `memberkit_${course.id}`)
      .single()

    if (existingClass) {
      console.log(`‚è≠Ô∏è Turma j√° existe: ${course.name}`)
      return existingClass
    }

    // Criar nova turma
    const { data: newClass, error } = await supabase
      .from('classes')
      .insert({
        name: course.name,
        description: course.description || `Importado da Memberkit - ${course.name}`,
        external_id: `memberkit_${course.id}`,
        status: 'active',
        class_type: 'standard',
        start_date: new Date().toISOString().split('T')[0],
        end_date: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +1 ano
        created_at: course.created_at,
        updated_at: course.updated_at
      })
      .select()
      .single()

    if (error) {
      console.error(`‚ùå Erro ao criar turma ${course.name}:`, error)
      throw error
    }

    console.log(`‚úÖ Turma criada: ${course.name}`)
    return newClass
  } catch (error) {
    console.error(`‚ùå Erro ao importar curso ${course.name}:`, error)
    throw error
  }
}

/**
 * Importa TODOS os cursos da Memberkit
 */
export async function importAllMemberkitCourses() {
  console.log('üöÄ Iniciando importa√ß√£o de cursos da Memberkit...')

  try {
    const courses = await fetchMemberkitCourses()

    console.log(`üìä Importando ${courses.length} cursos...`)

    const results = {
      total: courses.length,
      imported: 0,
      skipped: 0,
      errors: 0
    }

    for (const course of courses) {
      try {
        await importCourseToClass(course)
        results.imported++
      } catch (error) {
        console.error(`‚ùå Falha ao importar ${course.name}:`, error)
        results.errors++
      }

      // Pequeno delay entre imports
      await new Promise(resolve => setTimeout(resolve, 100))
    }

    console.log('‚úÖ Importa√ß√£o conclu√≠da!')
    console.log(`üìä Resultados:`)
    console.log(`   Total: ${results.total}`)
    console.log(`   Importados: ${results.imported}`)
    console.log(`   Ignorados (j√° existiam): ${results.skipped}`)
    console.log(`   Erros: ${results.errors}`)

    return results
  } catch (error) {
    console.error('‚ùå Erro na importa√ß√£o:', error)
    throw error
  }
}
